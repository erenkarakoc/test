(function(){toastr.options={positionClass:"toast-top-center",timeOut:"1000",showDuration:"30",hideDuration:"30"};const s=document.querySelector("#updateUserProfileForm"),b=FormValidation.formValidation(s,{fields:{username:{validators:{notEmpty:{message:"Please enter a username"},stringLength:{min:8,max:50,message:"Username must be between 8 and 50 characters"}}},full_name:{validators:{stringLength:{min:3,max:50,message:"Full name must be between 3 and 50 characters"},regexp:{regexp:/^[a-zA-Z\s]+$/,message:"Full name can only contain letters"}}},country:{validators:{}},phone_number:{validators:{callback:{message:"Please enter a valid phone number",callback:e=>e.value.trim()?libphonenumber.isValidNumber(e.value.trim()):!0}}},date_of_birth:{validators:{date:{format:"YYYY-MM-DD",message:"Please enter a valid date in YYYY-MM-DD format"}}}},plugins:{trigger:new FormValidation.plugins.Trigger,bootstrap5:new FormValidation.plugins.Bootstrap5({eleValidClass:"",rowSelector:".update-profile-info-row"}),autoFocus:new FormValidation.plugins.AutoFocus},init:e=>{e.on("plugins.message.placed",function(t){t.element.parentElement.classList.contains("input-group")&&t.element.parentElement.insertAdjacentElement("afterend",t.messageElement)})}}),f=document.querySelector("#display_username"),i=document.querySelector("#display_full_name"),l=document.querySelector("#display_country"),c=document.querySelector("#display_phone_number"),u=document.querySelector("#display_date_of_birth"),d=document.querySelector("#display_2fa"),y=e=>{const t='<small><i class="fw-light text-light">Not set yet</i></small>';e.username&&(f.innerHTML=`<span>${e.username}</span>`),e.full_name?i.innerHTML=`<span>${e.full_name}</span>`:i.innerHTML=t,e.country?l.innerHTML=`<span>${e.country}</span>`:l.innerHTML=t,e.phone_number?c.innerHTML=`<span>${e.phone_number}</span>`:c.innerHTML=t,e.date_of_birth?u.innerHTML=`<span>${e.date_of_birth}</span>`:u.innerHTML=t,e.twofa?d.innerHTML='<small class="text-success">Active</small>':d.innerHTML=t},g=async(e,t)=>(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify(t)})).json(),n=document.querySelector("#profileSaveButton");s.addEventListener("submit",async e=>{if(e.preventDefault(),await b.validate()==="Valid"){n.setAttribute("disabled",!0),n.querySelector("span").innerHTML=n.getAttribute("data-loading-text"),n.querySelector("svg").classList.remove("loading-hidden");const a=e.target,o=new FormData(a),h={username:o.get("username"),full_name:o.get("full_name"),country:o.get("country"),phone_number:o.get("phone_number"),date_of_birth:document.querySelector("#date_of_birth").value},p=await g("/user/update-user-profile",h);p.success&&setTimeout(()=>{n.querySelector("span").innerHTML=n.getAttribute("data-text"),n.querySelector("svg").classList.add("loading-hidden"),n.removeAttribute("disabled"),toastr.success("Profile updated."),y(p.updated_user)},500)}else toastr.error("Please correct the errors before submitting.")}),document.addEventListener("click",e=>{const t=e.target.closest(".copy-recovery-code");if(t){const a=t.closest(".input-group").querySelector(".form-control");navigator.clipboard.writeText(a.value.trim()).then(()=>{a.select()})}});const m=document.querySelector("#date_of_birth"),r=document.querySelector("#clearDateOfBirth");m.addEventListener("input",e=>{e.target.value&&(r.style.display="block")}),r.addEventListener("click",()=>{m.value="",r.style.display="none"}),document.querySelectorAll("[data-summary-item-target]").forEach(e=>{e.addEventListener("click",()=>{const t=new URL(window.location),a=e.getAttribute("data-summary-item-target");a==="2fa"?(new bootstrap.Tab(document.querySelector("[data-bs-target='#security']")).show(),t.searchParams.set("tab","security"),window.history.pushState({},"",t),document.querySelector(".two-factor-authentication-form > div").style.background="#151515",setTimeout(()=>{document.querySelector(".two-factor-authentication-form > div").style.background=""},1500)):(new bootstrap.Tab(document.querySelector("[data-bs-target='#update-profile']")).show(),t.searchParams.set("tab","update-profile"),window.history.pushState({},"",t),document.querySelector("#"+a).focus())})}),document.querySelectorAll(".nav-link").forEach(e=>{const t=e.getAttribute("data-bs-target");e.addEventListener("click",()=>{const a=new URL(window.location);a.searchParams.set("tab",t.replace("#","")),window.history.pushState({},"",a)})}),document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);e.get("tab")&&new bootstrap.Tab(document.querySelector(`[data-bs-target="#${e.get("tab")}"]`)).show()}),window.addEventListener("popstate",()=>{const e=new URLSearchParams(window.location.search);new bootstrap.Tab(document.querySelector(`[data-bs-target="#${e.get("tab")}"]`)).show()})})();
